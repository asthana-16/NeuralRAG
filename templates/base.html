<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{% block title %}NeuralRAG{% endblock %}</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
/* â”€â”€ DESIGN SYSTEM â”€â”€ */
:root {
  --bg:        #080c10;
  --surface:   #0d1117;
  --surface2:  #161b22;
  --border:    #21262d;
  --border2:   #30363d;
  --primary:   #58a6ff;
  --primary-d: #1f6feb;
  --accent:    #3fb950;
  --accent2:   #bc8cff;
  --warn:      #d29922;
  --danger:    #f85149;
  --text:      #e6edf3;
  --text2:     #8b949e;
  --text3:     #6e7681;
  --glow:      rgba(88,166,255,0.15);
  --glow-g:    rgba(63,185,80,0.1);
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; }
body {
  font-family: 'Syne', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  display: flex;
  overflow-x: hidden;
}
/* scanline texture */
body::before {
  content: '';
  position: fixed; inset: 0;
  background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,.03) 2px, rgba(0,0,0,.03) 4px);
  pointer-events: none; z-index: 9999;
}

/* â”€â”€ SIDEBAR â”€â”€ */
.sidebar {
  width: 240px; min-height: 100vh;
  background: var(--surface);
  border-right: 1px solid var(--border);
  display: flex; flex-direction: column;
  position: fixed; top: 0; left: 0; z-index: 100;
  transition: transform .3s;
}
.sb-brand {
  padding: 20px 18px 16px;
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; gap: 10px;
}
.sb-logo {
  width: 38px; height: 38px; border-radius: 10px;
  background: linear-gradient(135deg, var(--primary-d), var(--accent2));
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; box-shadow: 0 0 20px rgba(88,166,255,.3);
}
.sb-name { font-size: 17px; font-weight: 800; letter-spacing: -.3px; color: var(--text); }
.sb-name span { color: var(--primary); }

.sb-nav { flex: 1; padding: 12px 10px; overflow-y: auto; }
.sb-group { margin-bottom: 20px; }
.sb-label {
  font-family: 'Space Mono', monospace;
  font-size: 10px; text-transform: uppercase; letter-spacing: 1.5px;
  color: var(--text3); padding: 0 8px; margin-bottom: 6px;
}
.sb-link {
  display: flex; align-items: center; gap: 9px;
  padding: 9px 10px; border-radius: 8px;
  color: var(--text2); font-size: 14px; font-weight: 600;
  text-decoration: none; transition: all .15s; margin-bottom: 2px;
  position: relative;
}
.sb-link:hover { background: var(--surface2); color: var(--text); }
.sb-link.active {
  background: rgba(88,166,255,.1);
  color: var(--primary);
  box-shadow: inset 3px 0 0 var(--primary);
}
.sb-icon { font-size: 16px; width: 22px; text-align: center; }
.sb-badge {
  margin-left: auto; background: var(--primary-d);
  color: var(--text); font-size: 10px; font-weight: 700;
  padding: 1px 7px; border-radius: 10px; font-family: 'Space Mono', monospace;
}

.sb-footer {
  padding: 14px 12px;
  border-top: 1px solid var(--border);
}
.user-card {
  display: flex; align-items: center; gap: 10px;
  padding: 10px; border-radius: 10px;
  background: var(--surface2); border: 1px solid var(--border);
  margin-bottom: 10px;
}
.u-avatar {
  width: 34px; height: 34px; border-radius: 8px;
  display: flex; align-items: center; justify-content: center;
  font-size: 14px; font-weight: 800; color: #fff; flex-shrink: 0;
}
.u-name { font-size: 13px; font-weight: 700; line-height: 1.2; }
.u-sub  { font-size: 11px; color: var(--text3); font-family: 'Space Mono', monospace; }
.logout-link {
  display: flex; align-items: center; justify-content: center; gap: 6px;
  padding: 8px; border-radius: 8px; border: 1px solid var(--border);
  color: var(--text2); font-size: 13px; font-weight: 600;
  text-decoration: none; transition: all .15s;
}
.logout-link:hover { background: rgba(248,81,73,.1); border-color: var(--danger); color: var(--danger); }

/* â”€â”€ MAIN â”€â”€ */
.main { margin-left: 240px; flex: 1; display: flex; flex-direction: column; min-height: 100vh; }
.topbar {
  position: sticky; top: 0; z-index: 50;
  background: rgba(8,12,16,.85);
  backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--border);
  padding: 14px 28px;
  display: flex; align-items: center; justify-content: space-between;
}
.page-heading { font-size: 18px; font-weight: 800; letter-spacing: -.3px; }
.page-heading .ph-sub { font-size: 12px; color: var(--text3); font-weight: 400; font-family: 'Space Mono', monospace; }
.content { padding: 28px; flex: 1; max-width: 1200px; width: 100%; }

/* â”€â”€ FLASH MESSAGES â”€â”€ */
.flashes { padding: 0 28px 0; }
.flash {
  display: flex; align-items: center; gap: 10px;
  padding: 11px 16px; border-radius: 8px; margin-bottom: 8px;
  font-size: 13px; font-weight: 600; border-left: 3px solid;
  animation: slideIn .3s ease;
}
@keyframes slideIn { from { opacity:0; transform: translateY(-8px); } to { opacity:1; transform: translateY(0); } }
.flash-success { background: rgba(63,185,80,.08); border-color: var(--accent); color: #7ee787; }
.flash-error   { background: rgba(248,81,73,.08);  border-color: var(--danger); color: #ff7b72; }
.flash-warning { background: rgba(210,153,34,.08); border-color: var(--warn);   color: #e3b341; }
.flash-info    { background: rgba(88,166,255,.08); border-color: var(--primary); color: var(--primary); }
.flash-close   { margin-left: auto; background: none; border: none; cursor: pointer; color: inherit; opacity: .6; font-size: 16px; }

/* â”€â”€ CARDS â”€â”€ */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 24px;
}
.card-sm { padding: 16px; }
.card-title { font-size: 15px; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
.card-title .ct-icon { font-size: 18px; }

/* â”€â”€ STAT CARDS â”€â”€ */
.stats-row { display: grid; grid-template-columns: repeat(4,1fr); gap: 16px; margin-bottom: 28px; }
.stat-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 12px; padding: 20px;
  position: relative; overflow: hidden; transition: border-color .2s;
}
.stat-card:hover { border-color: var(--border2); }
.stat-card::after {
  content: ''; position: absolute; top: 0; right: 0;
  width: 60px; height: 60px; border-radius: 0 12px 0 60px;
  background: var(--glow); opacity: .5;
}
.sc-val { font-size: 30px; font-weight: 800; line-height: 1; margin-bottom: 4px; }
.sc-label { font-size: 12px; color: var(--text3); font-family: 'Space Mono', monospace; text-transform: uppercase; }
.sc-icon { font-size: 24px; margin-bottom: 8px; }

/* â”€â”€ FORMS â”€â”€ */
.form-row { margin-bottom: 20px; }
label {
  display: block; margin-bottom: 6px;
  font-size: 12px; font-weight: 700; text-transform: uppercase;
  letter-spacing: .8px; color: var(--text2);
  font-family: 'Space Mono', monospace;
}
input[type=text], input[type=email], input[type=password],
input[type=search], textarea, select {
  width: 100%; padding: 11px 14px;
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 8px; color: var(--text); font-size: 14px;
  font-family: 'Syne', sans-serif; transition: border-color .2s, box-shadow .2s;
}
input:focus, textarea:focus, select:focus {
  outline: none; border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(88,166,255,.12);
}
textarea { resize: vertical; min-height: 140px; line-height: 1.6; }
select { cursor: pointer; }
.input-hint { font-size: 11px; color: var(--text3); margin-top: 4px; font-family: 'Space Mono', monospace; }

/* â”€â”€ BUTTONS â”€â”€ */
.btn {
  display: inline-flex; align-items: center; gap: 7px;
  padding: 9px 18px; border-radius: 8px; border: none;
  font-size: 13px; font-weight: 700; cursor: pointer;
  text-decoration: none; transition: all .15s; font-family: 'Syne', sans-serif;
  letter-spacing: .3px;
}
.btn-primary {
  background: var(--primary-d); color: #fff;
  box-shadow: 0 0 0 1px rgba(88,166,255,.2);
}
.btn-primary:hover { background: var(--primary); color: #fff; box-shadow: 0 0 16px rgba(88,166,255,.3); }
.btn-green  { background: rgba(63,185,80,.15); color: var(--accent); border: 1px solid rgba(63,185,80,.3); }
.btn-green:hover  { background: rgba(63,185,80,.25); }
.btn-danger { background: rgba(248,81,73,.12); color: var(--danger); border: 1px solid rgba(248,81,73,.25); }
.btn-danger:hover { background: rgba(248,81,73,.2); }
.btn-ghost  { background: transparent; color: var(--text2); border: 1px solid var(--border); }
.btn-ghost:hover  { background: var(--surface2); color: var(--text); }
.btn-sm { padding: 6px 12px; font-size: 12px; }
.btn-xs { padding: 4px 9px; font-size: 11px; border-radius: 6px; }

/* â”€â”€ TABLE â”€â”€ */
.table-wrap { overflow-x: auto; border-radius: 10px; border: 1px solid var(--border); }
table { width: 100%; border-collapse: collapse; }
th {
  text-align: left; padding: 11px 16px; font-size: 11px;
  font-family: 'Space Mono', monospace; text-transform: uppercase;
  letter-spacing: .8px; color: var(--text3);
  background: var(--surface2); border-bottom: 1px solid var(--border);
}
td { padding: 13px 16px; font-size: 13px; border-bottom: 1px solid rgba(33,38,45,.6); vertical-align: middle; }
tr:last-child td { border-bottom: none; }
tr:hover td { background: rgba(33,38,45,.5); }
.tr-actions { display: flex; gap: 6px; justify-content: flex-end; }

/* â”€â”€ BADGES / TAGS â”€â”€ */
.badge {
  display: inline-flex; align-items: center;
  padding: 3px 9px; border-radius: 20px;
  font-size: 11px; font-weight: 700; font-family: 'Space Mono', monospace;
}
.badge-blue   { background: rgba(88,166,255,.15); color: var(--primary); border: 1px solid rgba(88,166,255,.2); }
.badge-green  { background: rgba(63,185,80,.15);  color: var(--accent);  border: 1px solid rgba(63,185,80,.2); }
.badge-purple { background: rgba(188,140,255,.15); color: var(--accent2); border: 1px solid rgba(188,140,255,.2); }
.badge-warn   { background: rgba(210,153,34,.15); color: var(--warn);    border: 1px solid rgba(210,153,34,.2); }
.tag {
  display: inline-block; padding: 2px 8px; margin: 2px;
  border-radius: 4px; font-size: 11px; font-family: 'Space Mono', monospace;
  background: rgba(88,166,255,.08); color: var(--text2); border: 1px solid var(--border);
}

/* â”€â”€ CAPTCHA â”€â”€ */
.captcha-box { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
.captcha-img { border-radius: 8px; border: 1px solid var(--border); display: block; cursor: pointer; }
.captcha-input-wrap { flex: 1; min-width: 140px; }
.captcha-input {
  font-family: 'Space Mono', monospace !important;
  letter-spacing: 6px; font-size: 18px; font-weight: 700;
  text-align: center; text-transform: uppercase;
}

/* â”€â”€ GRID â”€â”€ */
.grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
.grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }

/* â”€â”€ EMPTY STATE â”€â”€ */
.empty-state {
  text-align: center; padding: 60px 20px; color: var(--text3);
}
.empty-icon { font-size: 48px; margin-bottom: 14px; opacity: .5; }
.empty-title { font-size: 17px; font-weight: 700; color: var(--text2); margin-bottom: 6px; }
.empty-sub { font-size: 13px; font-family: 'Space Mono', monospace; }

/* â”€â”€ AUTH PAGE â”€â”€ */
.auth-wrap {
  min-height: 100vh; width: 100%;
  display: flex; align-items: center; justify-content: center;
  background: var(--bg);
  background-image:
    radial-gradient(ellipse 80% 50% at 50% -20%, rgba(88,166,255,.12), transparent),
    radial-gradient(ellipse 60% 40% at 80% 80%, rgba(63,185,80,.06), transparent);
  padding: 24px;
}
.auth-card {
  width: 100%; max-width: 440px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 16px; padding: 40px;
  box-shadow: 0 24px 80px rgba(0,0,0,.5);
}
.auth-logo { text-align: center; margin-bottom: 28px; }
.auth-logo-icon {
  width: 56px; height: 56px; border-radius: 14px;
  background: linear-gradient(135deg, var(--primary-d), var(--accent2));
  display: flex; align-items: center; justify-content: center;
  font-size: 26px; margin: 0 auto 14px;
  box-shadow: 0 0 30px rgba(88,166,255,.3);
}
.auth-title { font-size: 24px; font-weight: 800; letter-spacing: -.5px; }
.auth-sub { font-size: 13px; color: var(--text3); margin-top: 4px; font-family: 'Space Mono', monospace; }

/* â”€â”€ MISC â”€â”€ */
hr { border: none; border-top: 1px solid var(--border); margin: 20px 0; }
.mt-4 { margin-top: 16px; }
.mb-4 { margin-bottom: 16px; }
.flex { display: flex; }
.items-center { align-items: center; }
.justify-between { justify-content: space-between; }
.gap-2 { gap: 8px; }
.gap-3 { gap: 12px; }
.text-muted { color: var(--text3); font-size: 13px; font-family: 'Space Mono', monospace; }
.text-sm { font-size: 13px; }
code, .mono { font-family: 'Space Mono', monospace; font-size: 12px; }
a { color: var(--primary); text-decoration: none; }
a:hover { text-decoration: underline; }

/* â”€â”€ PROGRESS BAR â”€â”€ */
.prog-bar { height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; }
.prog-fill { height: 100%; border-radius: 2px; transition: width .3s; }

@media (max-width: 900px) {
  .sidebar { transform: translateX(-100%); }
  .main { margin-left: 0; }
  .stats-row { grid-template-columns: 1fr 1fr; }
  .grid-3 { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

{% if session.get('user_id') %}
<!-- SIDEBAR -->
<aside class="sidebar" id="sidebar">
  <div class="sb-brand">
    <div class="sb-logo">ðŸ§ </div>
    <div class="sb-name">Neural<span>RAG</span></div>
  </div>
  <nav class="sb-nav">
    <div class="sb-group">
      <div class="sb-label">// overview</div>
      <a href="{{ url_for('dashboard') }}" class="sb-link {% if request.endpoint=='dashboard' %}active{% endif %}">
        <span class="sb-icon">â¬¡</span> Dashboard
      </a>
    </div>
    <div class="sb-group">
      <div class="sb-label">// knowledge</div>
      <a href="{{ url_for('documents') }}" class="sb-link {% if 'doc' in (request.endpoint or '') %}active{% endif %}">
        <span class="sb-icon">â—«</span> Documents
      </a>
      <a href="{{ url_for('doc_create') }}" class="sb-link">
        <span class="sb-icon">ï¼‹</span> New Document
      </a>
    </div>
    <div class="sb-group">
      <div class="sb-label">// ai chat</div>
      <a href="{{ url_for('chat_list') }}" class="sb-link {% if 'chat' in (request.endpoint or '') %}active{% endif %}">
        <span class="sb-icon">â—ˆ</span> Chat Sessions
      </a>
      <a href="{{ url_for('chat_new') }}" class="sb-link">
        <span class="sb-icon">â—‰</span> New Chat
      </a>
    </div>
    <div class="sb-group">
      <div class="sb-label">// account</div>
      <a href="{{ url_for('settings') }}" class="sb-link {% if request.endpoint=='settings' %}active{% endif %}">
        <span class="sb-icon">â—Ž</span> Settings
      </a>
    </div>
  </nav>
  <div class="sb-footer">
    <div class="user-card">
      <div class="u-avatar" style="background:{{ get_current_user()['avatar_color'] if get_current_user() else '#6c63ff' }}">
        {{ session.username[0].upper() }}
      </div>
      <div>
        <div class="u-name">{{ session.username }}</div>
        <div class="u-sub">rag user</div>
      </div>
    </div>
    <a href="{{ url_for('logout') }}" class="logout-link">âŽ‹ Sign Out</a>
  </div>
</aside>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <div>
      <div class="page-heading">{% block page_title %}{% endblock %}</div>
      <div class="page-heading ph-sub" style="margin-top:2px">{% block page_sub %}{% endblock %}</div>
    </div>
    <div>{% block topbar_right %}{% endblock %}</div>
  </div>

  <div class="flashes">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% for cat, msg in messages %}
      <div class="flash flash-{{ cat }}">
        {% if cat=='success' %}âœ“{% elif cat=='error' %}âœ•{% elif cat=='warning' %}âš {% else %}i{% endif %}
        {{ msg }}
        <button class="flash-close" onclick="this.parentElement.remove()">Ã—</button>
      </div>
      {% endfor %}
    {% endwith %}
  </div>

  <div class="content">{% block content %}{% endblock %}</div>
</div>

{% else %}
{% block auth_content %}{% endblock %}
{% endif %}

<script>
// Auto-remove flashes
setTimeout(() => document.querySelectorAll('.flash').forEach(f => f.style.opacity='0'), 4000);
setTimeout(() => document.querySelectorAll('.flash').forEach(f => f.remove()), 4500);

// Captcha refresh utility
function refreshCaptcha(imgId, inputSelector) {
  fetch('/captcha-refresh').then(r => r.json()).then(d => {
    document.getElementById(imgId).src = d.image;
    const inp = document.querySelector(inputSelector);
    if (inp) inp.value = '';
  });
}
</script>
{% block scripts %}{% endblock %}
</body>
</html>
